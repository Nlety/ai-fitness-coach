const STORAGE_KEY = 'ai_fitness_records';
const API_BASE = '/api/fitness-storage';
async function getRecords() { try { const local = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); try { const r = await fetch(`${API_BASE}?action=list`); if (r.ok) { const c = await r.json(); if (c.records) { const m = mergeData(local, c.records); localStorage.setItem(STORAGE_KEY, JSON.stringify(m)); return m; } } } catch (e) { } return local; } catch (e) { return []; } }
function mergeData(local, cloud) { const map = new Map();[...local, ...cloud].forEach(r => { if (!map.has(r.id) || r.updatedAt > map.get(r.id).updatedAt) map.set(r.id, r); }); return Array.from(map.values()).sort((a, b) => b.createdAt - a.createdAt); }
async function saveRecord(record) { try { const records = await getRecords(); const now = Date.now(); if (!record.id) { record.id = `fit_${now}_${Math.random().toString(36).slice(2, 8)}`; record.createdAt = now; } record.updatedAt = now; const index = records.findIndex(r => r.id === record.id); if (index >= 0) records[index] = record; else records.unshift(record); localStorage.setItem(STORAGE_KEY, JSON.stringify(records)); let cloudSync = false; try { const r = await fetch(API_BASE, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'save', record }) }); cloudSync = r.ok; } catch (e) { } return { success: true, cloudSync }; } catch (e) { return { success: false }; } }
window.StorageService = { getRecords, saveRecord };
